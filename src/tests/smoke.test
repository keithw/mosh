#!/bin/sh
: ${srcdir:=$PWD}
echo starting
if [ ! -t 0 ]; then
    if ! type tmux > /dev/null; then
	printf "tmux not found\n" >&2
	exit 77
    fi
    output="$(${srcdir}/hold-stdin tmux -C new-session $0 2>&1)"
    rc=$?
else
    output="$(../../scripts/mosh --local --client=../frontend/mosh-client --server="$PWD/../frontend/mosh-server" --bind-server=127.0.0.1 127.0.0.1 printf xy%s zzy 2>&1)"
    rc=$?
fi
if ! (printf "%s\n" "$output" | grep -q xyzzyq); then
    rc=1
    if [ "x$AM_TESTS_REDIRECT" != "x" ]; then
	(
	    printf "travis_fold:start:smoke\n"
	    printf "%s\n" "$output"
	    printf "travis_fold:end:smoke\n"
	) >&9
    fi
fi
echo ending
exit $rc
