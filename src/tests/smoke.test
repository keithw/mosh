#!/bin/sh -x
: ${srcdir:=$PWD}
echo starting
if [ ! -t 0 ]; then
    if ! type tmux; then
	printf "tmux not found\n" >&2
	exit 77
    fi
    ${srcdir}/hold-stdin tmux -C new-session $0 | grep xyzzy
    rc=$?
else
    output="$(../../scripts/mosh --local --client=../frontend/mosh-client --server="$PWD/../frontend/mosh-server" --bind-server=127.0.0.1 127.0.0.1 printf xy%s zzy 2>&1)"
    rc=$?
    if !(echo "$output" | grep xyzzy); then
	rc=1
    fi
fi
echo ending
exit $rc
